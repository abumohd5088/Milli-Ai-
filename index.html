<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milli AI - Your Study Buddy</title>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --white: #fff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark-color);
            position: relative;
        }

        .icon-btn.dark-mode .notification-badge {
            background-color: #ff4081;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff5722;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .landing-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 70vh;
            padding: 20px;
        }

        .landing-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .landing-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 40px;
            max-width: 600px;
        }

        .new-chat-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: transform 0.2s;
        }

        .new-chat-btn:hover {
            transform: scale(1.1);
        }

        .chat-container {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: var(--border-radius);
            position: relative;
        }

        .user-message {
            background-color: var(--secondary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background-color: var(--white);
            color: var(--dark-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: var(--shadow);
        }

        body.dark-mode .ai-message {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.5;
        }

        .suggestion {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 3px solid var(--secondary-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            font-style: italic;
            font-size: 0.9rem;
        }

        .message-actions {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .ai-message:hover .message-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 3px 5px;
            border-radius: 3px;
            color: var(--dark-color);
        }

        .action-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .chat-input-container {
            display: flex;
            padding: 15px 0;
            border-top: 1px solid rgba(0,0,0,0.1);
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .send-btn:hover {
            background-color: #1b5e20;
        }

        .stop-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            display: none;
        }

        .file-upload {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
            opacity: 0.6;
        }

        .chat-options {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            z-index: 5;
        }

        .options-menu {
            display: none;
            position: absolute;
            top: 35px;
            right: 0;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 10px 0;
            min-width: 150px;
            z-index: 100;
        }

        .options-menu.show {
            display: block;
        }

        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .menu-item:hover {
            background-color: #f0f0f0;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background-color: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        body.dark-mode .settings-content {
            background-color: #1e1e1e;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-color);
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .toggle-label {
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .info-section {
            background-color: rgba(46, 125, 50, 0.05);
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .info-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .maintenance-banner {
            background-color: #ff5722;
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: none;
        }

        .image-container {
            margin: 15px 0;
            text-align: center;
        }

        .generated-image {
            max-width: 100%;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .image-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .image-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .image-btn:hover {
            background-color: #1b5e20;
        }

        .footer {
            text-align: center;
            padding: 20px 0;
            font-size: 0.9rem;
            color: #666;
            border-top: 1px solid rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .landing-title {
                font-size: 2rem;
            }
            
            .landing-subtitle {
                font-size: 1rem;
            }
            
            .new-chat-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="maintenance-banner" id="maintenanceBanner">
        ‚ö†Ô∏è System Maintenance in Progress - Some features may be temporarily unavailable
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">M</div>
                Milli AI
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="notificationBtn">
                    üîî
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="landing-screen" id="landingScreen">
            <h1 class="landing-title">Ask me anything about study (Mill Karwaan Public School)</h1>
            <p class="landing-subtitle">Powered by Milli AI ‚Äî Your Study Buddy</p>
            <button class="new-chat-btn" id="newChatBtn">+</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <button class="file-upload" title="Upload file (coming soon)">üìé</button>
                <input type="text" class="chat-input" id="chatInput" placeholder="What can I help with study?" autocomplete="off">
                <button class="send-btn" id="sendBtn">Send</button>
                <button class="stop-btn" id="stopBtn">Stop</button>
            </div>
        </div>

        <div class="footer">
            Designed for MKPS by Abutalha ‚ù§Ô∏è
        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" id="closeSettings">&times;</button>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Appearance</h3>
                <div class="toggle-container">
                    <span class="toggle-label">Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Language</h3>
                <div class="toggle-container">
                    <span class="toggle-label">UI Language: English</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="languageToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <p style="font-size: 0.8rem; margin-top: 5px; color: #666;">Toggle to switch between English and Hindi</p>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">About School</h3>
                <div class="info-section">
                    <div class="info-title">Mill Karwaan Public School, Balrampur</div>
                    <p>Principal: Md Arshad Alig</p>
                    <p>Contact: 9758919151</p>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">About Dev</h3>
                <div class="info-section">
                    <div class="info-title">Created by Abutalha ‚Äî Proud Student of MKPS üéì</div>
                    <p>Genius Developer | AI Enthusiast | Future Tech Leader</p>
                    <p>Contact: 9839469669</p>
                    <p>"Built with love for my school!"</p>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Terms & Conditions</h3>
                <div class="info-section">
                    <p>1. Milli AI is designed for educational purposes only.</p>
                    <p>2. Do not use for cheating or academic dishonesty.</p>
                    <p>3. The school is not responsible for content generated by AI.</p>
                    <p>4. Use responsibly and ethically.</p>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Archived Chats</h3>
                <div id="archivedChats" class="info-section">
                    <p>No archived chats yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const landingScreen = document.getElementById('landingScreen');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const stopBtn = document.getElementById('stopBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettings = document.getElementById('closeSettings');
        const settingsModal = document.getElementById('settingsModal');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const languageToggle = document.getElementById('languageToggle');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationCount = document.getElementById('notificationCount');
        const maintenanceBanner = document.getElementById('maintenanceBanner');

        // State variables
        let isGenerating = false;
        let currentAbortController = null;
        let chats = JSON.parse(localStorage.getItem('milliAI_chats') || '[]');
        let archivedChats = JSON.parse(localStorage.getItem('milliAI_archived') || '[]');
        let notifications = [];
        let unreadNotifications = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadChats();
            checkDarkMode();
            setupEventListeners();
            checkForMaintenance();
            simulateNotifications();
        });

        function setupEventListeners() {
            // New Chat button
            newChatBtn.addEventListener('click', startNewChat);
            
            // Send message
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Stop generating
            stopBtn.addEventListener('click', stopGenerating);
            
            // Settings
            settingsBtn.addEventListener('click', openSettings);
            closeSettings.addEventListener('click', closeSettingsModal);
            
            // Dark mode toggle
            darkModeToggle.addEventListener('change', toggleDarkMode);
            
            // Language toggle
            languageToggle.addEventListener('change', toggleLanguage);
            
            // Click outside settings modal to close
            window.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    closeSettingsModal();
                }
            });
            
            // Notification button
            notificationBtn.addEventListener('click', showNotifications);
        }

        function startNewChat() {
            landingScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            chatInput.focus();
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isGenerating) return;
            
            // Add user message
            addMessageToChat('user', message);
            chatInput.value = '';
            
            // Show stop button
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            
            // Set generating state
            isGenerating = true;
            currentAbortController = new AbortController();
            
            try {
                // Check if it's an image generation request
                if (message.toLowerCase().includes('generate image for') || message.toLowerCase().includes('generate image of')) {
                    await generateImage(message);
                } else {
                    // Use Gemini API for text response
                    await generateTextResponse(message);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessageToChat('ai', 'Sorry, I encountered an error. Please try again.');
            } finally {
                // Hide stop button, show send button
                stopBtn.style.display = 'none';
                sendBtn.style.display = 'block';
                isGenerating = false;
                currentAbortController = null;
            }
        }

        async function generateTextResponse(prompt) {
            const apiKey1 = 'AIzaSyB4xCisV5WXwLKpBgh75ZWk1JaZdMptoQs';
            const apiKey2 = 'AIzaSyCqGS8gb5kh7Jr0pv8d84LxCLhgHU-O_VU';
            
            let responseText = '';
            let usedApiKey = apiKey1;
            
            try {
                // Try first API key
                responseText = await callGeminiAPI(prompt, apiKey1);
            } catch (error) {
                console.log('First API key failed, trying fallback...');
                usedApiKey = apiKey2;
                try {
                    responseText = await callGeminiAPI(prompt, apiKey2);
                } catch (error) {
                    console.error('Both API keys failed:', error);
                    responseText = 'I\'m having trouble connecting right now. Please try again later.';
                }
            }
            
            // Check if it's a non-study question
            const studyTopics = ['math', 'science', 'history', 'geography', 'english', 'hindi', 'physics', 'chemistry', 'biology', 'computer', 'study', 'learn', 'education', 'school', 'homework', 'assignment', 'exam', 'test', 'quiz', 'subject', 'chapter', 'lesson', 'topic', 'concept', 'theory', 'formula', 'equation', 'problem', 'solution', 'answer', 'explain', 'describe', 'define', 'what is', 'how to', 'why', 'when', 'where', 'who', 'which'];
            const isStudyRelated = studyTopics.some(topic => prompt.toLowerCase().includes(topic));
            
            if (!isStudyRelated && !prompt.toLowerCase().includes('milli ai') && !prompt.toLowerCase().includes('who are you')) {
                responseText = "I'm designed to help with study topics. Try asking about Science, Math, History etc. üòä";
            } else if (prompt.toLowerCase().includes('who are you') || prompt.toLowerCase().includes('milli ai')) {
                responseText = "I'm Milli AI, your study assistant from MKPS Balrampur! I'm here to help you with your studies, explain concepts, and make learning easier and more fun. What would you like to learn today?";
            }
            
            // Add AI response
            addMessageToChat('ai', responseText);
            
            // Add suggestion
            const suggestions = [
                "--- Try asking: 'Explain Newton's Laws' or 'Generate image for photosynthesis'",
                "--- Want to test your knowledge? Ask me for a quiz on this topic!",
                "--- Need more details? Ask me to explain this in simpler terms.",
                "--- Want an image for this topic? Just say 'generate image for [topic]'",
                "--- Try asking: 'What are the key points I should remember about this topic?'"
            ];
            const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            addSuggestionToLastMessage(randomSuggestion);
        }

        async function callGeminiAPI(prompt, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                }),
                signal: currentAbortController.signal
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function generateImage(prompt) {
            try {
                // Extract the topic from the prompt
                let topic = prompt.replace(/generate image for|generate image of/gi, '').trim();
                
                // Create loading message
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.innerHTML = `
                    <div class="message-header">Milli AI ‚Ä¢ ${getCurrentDateTime()}</div>
                    <div class="message-content">
                        <div class="loading"></div> Generating image for "${topic}"...
                    </div>
                `;
                chatMessages.appendChild(loadingDiv);
                scrollToBottom();
                
                // Call Stable Horde API
                let submitRes = await fetch("https://stablehorde.net/api/v2/generate/async", {
                    method: "POST",
                    headers: {
                        "apikey": "4y9VQUFr3wiwNJOOnnuh1w",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        prompt: topic,
                        params: { steps: 20, width: 512, height: 512 },
                        nsfw: false
                    })
                });
                
                let submitData = await submitRes.json();
                if (!submitRes.ok) {
                    loadingDiv.innerHTML = `
                        <div class="message-header">Milli AI ‚Ä¢ ${getCurrentDateTime()}</div>
                        <div class="message-content">
                            ‚ùå Error: ${submitData.message || 'Failed to generate image'}
                        </div>
                    `;
                    return;
                }
                
                const jobId = submitData.id;
                
                // Poll for completion
                let imageUrl = null;
                let attempts = 0;
                const maxAttempts = 24; // 2 minutes max (5 sec * 24)
                
                while (!imageUrl && attempts < maxAttempts) {
                    await new Promise(r => setTimeout(r, 5000));
                    attempts++;
                    
                    let checkRes = await fetch(`https://stablehorde.net/api/v2/generate/status/${jobId}`);
                    let checkData = await checkRes.json();
                    
                    if (checkData.done && checkData.generations.length > 0) {
                        imageUrl = checkData.generations[0].img;
                        break;
                    }
                    
                    // Update loading message with progress
                    if (attempts < maxAttempts) {
                        loadingDiv.innerHTML = `
                            <div class="message-header">Milli AI ‚Ä¢ ${getCurrentDateTime()}</div>
                            <div class="message-content">
                                <div class="loading"></div> Generating image... (${attempts * 5} seconds elapsed)
                            </div>
                        `;
                    }
                }
                
                if (imageUrl) {
                    // Replace loading message with image
                    loadingDiv.innerHTML = `
                        <div class="message-header">Milli AI ‚Ä¢ ${getCurrentDateTime()}</div>
                        <div class="message-content">
                            Here's an image for "${topic}":
                            <div class="image-container">
                                <img src="${imageUrl}" alt="${topic}" class="generated-image" />
                                <div class="image-actions">
                                    <button class="image-btn" onclick="downloadImage('${imageUrl}', '${topic}')">Download</button>
                                    <button class="image-btn" onclick="openImagePreview('${imageUrl}')">Full Preview</button>
                                    <button class="image-btn" onclick="shareImage('${imageUrl}')">Share</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add suggestion
                    addSuggestionToLastMessage("--- Need another image? Try being more specific with your request!");
                } else {
                    loadingDiv.innerHTML = `
                        <div class="message-header">Milli AI ‚Ä¢ ${getCurrentDateTime()}</div>
                        <div class="message-content">
                            ‚ùå Sorry, image generation took too long. Please try again with a simpler prompt.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Image generation error:', error);
                addMessageToChat('ai', '‚ùå Sorry, there was an error generating the image. Please try again later.');
            }
        }

        function addMessageToChat(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const now = new Date();
            const formattedDate = now.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', '');
            
            messageDiv.innerHTML = `
                <div class="message-header">${sender === 'user' ? 'You' : 'Milli AI ‚Ä¢ ' + formattedDate}</div>
                <div class="message-content">${formatMessageContent(content)}</div>
                ${sender === 'ai' ? `
                    <div class="message-actions">
                        <button class="action-btn" onclick="copyToClipboard(this)">üìã Copy</button>
                        <button class="action-btn" onclick="regenerateResponse(this)">üîÑ Regenerate</button>
                        <button class="action-btn" onclick="likeMessage(this)">üëç Like</button>
                        <button class="action-btn" onclick="dislikeMessage(this)">üëé Dislike</button>
                        <button class="action-btn" onclick="shareMessage(this)">‚ÜóÔ∏è Share</button>
                    </div>
                ` : ''}
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            // Save to localStorage
            if (sender === 'user') {
                chats.push({
                    type: 'user',
                    content: content,
                    timestamp: new Date().toISOString()
                });
            } else {
                chats.push({
                    type: 'ai',
                    content: content,
                    timestamp: new Date().toISOString()
                });
            }
            saveChats();
        }

        function addSuggestionToLastMessage(suggestion) {
            const messages = chatMessages.querySelectorAll('.message');
            const lastMessage = messages[messages.length - 1];
            if (lastMessage && lastMessage.querySelector('.message-content')) {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'suggestion';
                suggestionDiv.textContent = suggestion;
                lastMessage.querySelector('.message-content').appendChild(suggestionDiv);
            }
        }

        function formatMessageContent(content) {
            // Convert URLs to links
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return content.replace(urlRegex, url => `<a href="${url}" target="_blank" style="color: var(--primary-color); text-decoration: underline;">${url}</a>`);
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function stopGenerating() {
            if (currentAbortController) {
                currentAbortController.abort();
                isGenerating = false;
                stopBtn.style.display = 'none';
                sendBtn.style.display = 'block';
                
                // Add message that generation was stopped
                addMessageToChat('ai', 'Generation stopped. You can ask another question now.');
            }
        }

        function openSettings() {
            settingsModal.style.display = 'flex';
            updateArchivedChatsDisplay();
        }

        function closeSettingsModal() {
            settingsModal.style.display = 'none';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('milliAI_darkMode', darkModeToggle.checked);
        }

        function checkDarkMode() {
            const isDarkMode = localStorage.getItem('milliAI_darkMode') === 'true';
            darkModeToggle.checked = isDarkMode;
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }
        }

        function toggleLanguage() {
            // This would toggle between English and Hindi UI
            // For now, we'll just show an alert since full translation would require more work
            alert('Language toggle feature would switch the UI between English and Hindi. This is a demo implementation.');
        }

        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', '');
        }

        function saveChats() {
            localStorage.setItem('milliAI_chats', JSON.stringify(chats));
        }

        function loadChats() {
            if (chats.length > 0) {
                landingScreen.style.display = 'none';
                chatContainer.style.display = 'flex';
                
                chats.forEach(chat => {
                    addMessageToChat(chat.type, chat.content);
                });
            }
        }

        function updateArchivedChatsDisplay() {
            const archivedChatsDiv = document.getElementById('archivedChats');
            if (archivedChats.length === 0) {
                archivedChatsDiv.innerHTML = '<p>No archived chats yet.</p>';
            } else {
                let html = '';
                archivedChats.forEach((chat, index) => {
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 5px;">
                            <div style="font-weight: bold;">${chat.title || 'Untitled Chat'}</div>
                            <div style="font-size: 0.8rem; color: #666;">${new Date(chat.timestamp).toLocaleString()}</div>
                            <button onclick="restoreArchivedChat(${index})" style="margin-top: 5px; background-color: var(--primary-color); color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Restore</button>
                        </div>
                    `;
                });
                archivedChatsDiv.innerHTML = html;
            }
        }

        function checkForMaintenance() {
            // In a real app, this would check with the server
            // For demo purposes, we'll randomly show maintenance banner 10% of the time
            if (Math.random() < 0.1) {
                maintenanceBanner.style.display = 'block';
            }
        }

        function simulateNotifications() {
            // Simulate receiving notifications
            setTimeout(() => {
                addNotification('New Feature', 'üìö Quiz mode is now available! Ask "quiz me on [topic]" to test your knowledge.', 'feature');
                addNotification('Holiday Notice', 'üè´ School will be closed on Monday for Teacher Training Day.', 'holiday');
                addNotification('System Update', '‚öôÔ∏è Milli AI will be updated tonight at 10 PM for better performance.', 'warning');
            }, 3000);
        }

        function addNotification(title, body, type) {
            notifications.push({
                title,
                body,
                type,
                timestamp: new Date().toISOString(),
                read: false
            });
            unreadNotifications++;
            updateNotificationCount();
        }

        function updateNotificationCount() {
            notificationCount.textContent = unreadNotifications;
            if (unreadNotifications > 0) {
                notificationCount.style.display = 'block';
            } else {
                notificationCount.style.display = 'none';
            }
        }

        function showNotifications() {
            if (notifications.length === 0) {
                alert('No notifications');
                return;
            }
            
            let notificationText = 'üîî Notifications:\n\n';
            notifications.forEach((notif, index) => {
                notificationText += `${index + 1}. ${notif.title}\n   ${notif.body}\n   ${new Date(notif.timestamp).toLocaleString()}\n\n`;
                notif.read = true;
            });
            
            alert(notificationText);
            unreadNotifications = 0;
            updateNotificationCount();
        }

        // Global functions for message actions
        function copyToClipboard(button) {
            const messageContent = button.closest('.message').querySelector('.message-content').innerText;
            navigator.clipboard.writeText(messageContent)
                .then(() => {
                    alert('Copied to clipboard!');
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                });
        }

        function regenerateResponse(button) {
            const messageDiv = button.closest('.message');
            const previousUserMessage = Array.from(chatMessages.querySelectorAll('.message'))
                .filter(msg => msg.classList.contains('user-message'))
                .pop();
            
            if (previousUserMessage) {
                const userMessage = previousUserMessage.querySelector('.message-content').innerText;
                // Remove the current AI message
                messageDiv.remove();
                // Remove from chats array
                chats.pop();
                // Send the message again
                chatInput.value = userMessage;
                sendMessage();
            }
        }

        function likeMessage(button) {
            button.textContent = 'üëç Liked';
            button.style.color = 'green';
            // In a real app, this would send feedback to the server
            console.log('Message liked');
        }

        function dislikeMessage(button) {
            button.textContent = 'üëé Disliked';
            button.style.color = 'red';
            // In a real app, this would send feedback to the server
            console.log('Message disliked');
        }

        function shareMessage(button) {
            const messageContent = button.closest('.message').querySelector('.message-content').innerText;
            if (navigator.share) {
                navigator.share({
                    title: 'Milli AI Response',
                    text: messageContent,
                })
                .catch(error => {
                    console.log('Error sharing:', error);
                    fallbackShare(messageContent);
                });
            } else {
                fallbackShare(messageContent);
            }
        }

        function fallbackShare(content) {
            const tempInput = document.createElement('input');
            tempInput.value = content;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert('Content copied to clipboard! You can now paste it anywhere.');
        }

        function downloadImage(url, topic) {
            const a = document.createElement('a');
            a.href = url;
            a.download = `milli-ai-${topic.replace(/\s+/g, '-').toLowerCase()}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function openImagePreview(url) {
            window.open(url, '_blank');
        }

        function shareImage(url) {
            if (navigator.share) {
                navigator.share({
                    title: 'Generated Image from Milli AI',
                    url: url,
                })
                .catch(error => {
                    console.log('Error sharing:', error);
                    fallbackShare(url);
                });
            } else {
                fallbackShare(url);
            }
        }

        function restoreArchivedChat(index) {
            const restoredChat = archivedChats.splice(index, 1)[0];
            chats.push(restoredChat);
            saveChats();
            localStorage.setItem('milliAI_archived', JSON.stringify(archivedChats));
            updateArchivedChatsDisplay();
            alert('Chat restored!');
        }
    </script>
</body>
</html>
