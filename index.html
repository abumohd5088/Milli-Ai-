<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milli AI - Study Assistant for MKPS Balrampur</title>
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #4caf50;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --background-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            position: relative;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .landing-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 70vh;
            padding: 20px;
        }

        .landing-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            line-height: 1.4;
        }

        .landing-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            max-width: 600px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 70vh;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: var(--primary-light);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background-color: var(--card-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .message-header {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-actions {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .message:hover .message-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .suggestion {
            font-style: italic;
            color: var(--primary-color);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--primary-light);
        }

        .input-container {
            display: flex;
            gap: 10px;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            background-color: var(--background-color);
            padding-bottom: 20px;
        }

        .input-box {
            flex: 1;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 16px;
            background-color: var(--card-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .input-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .send-btn, .stop-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .send-btn:hover {
            background-color: var(--primary-light);
        }

        .stop-btn {
            background-color: #f44336;
            color: white;
            display: none;
        }

        .stop-btn:hover {
            background-color: #d32f2f;
        }

        .attachment-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            padding: 10px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .attachment-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .new-chat-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            z-index: 100;
        }

        .new-chat-btn:hover {
            transform: scale(1.1);
            background-color: var(--primary-light);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background-color: var(--card-color);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            position: relative;
        }

        .close-settings {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .toggle-label {
            font-size: 16px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .info-section {
            background-color: rgba(46, 125, 50, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .info-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(46, 125, 50, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .maintenance-banner {
            background-color: #ffeb3b;
            color: #333;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 100;
            display: none;
        }

        .image-container {
            margin: 15px 0;
            text-align: center;
        }

        .generated-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .image-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .image-btn {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .image-btn:hover {
            background-color: var(--primary-light);
            color: white;
        }

        .dot-menu {
            position: relative;
            cursor: pointer;
        }

        .chat-menu {
            display: none;
            position: absolute;
            top: 30px;
            right: 0;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 100;
            min-width: 150px;
        }

        .chat-menu.active {
            display: block;
        }

        .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background-color: rgba(46, 125, 50, 0.1);
        }

        .footer {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .landing-title {
                font-size: 24px;
            }
            
            .landing-subtitle {
                font-size: 16px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .new-chat-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .input-container {
                flex-direction: column;
            }
            
            .send-btn, .stop-btn {
                width: 100%;
                padding: 12px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="maintenance-banner" id="maintenanceBanner">
        ‚ö†Ô∏è System Maintenance in Progress - Some features may be temporarily unavailable
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">M</div>
                Milli AI
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="notificationsBtn">
                    üîî
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </header>

        <div class="landing-screen" id="landingScreen">
            <h1 class="landing-title">Ask me anything about study (Mill Karwaan Public School)</h1>
            <p class="landing-subtitle">Powered by Milli AI ‚Äî Your Study Buddy</p>
            <button class="send-btn" id="startChatBtn">Start Chatting</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="messages-container" id="messagesContainer"></div>
            <div class="input-container">
                <button class="attachment-btn" title="Upload file (coming soon)">üìé</button>
                <input type="text" class="input-box" id="messageInput" placeholder="What can I help with study?" autocomplete="off">
                <button class="send-btn" id="sendBtn">Send</button>
                <button class="stop-btn" id="stopBtn">Stop</button>
            </div>
        </div>

        <div class="new-chat-btn" id="newChatBtn">+</div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-settings" id="closeSettings">&times;</button>
            <div class="settings-section">
                <h2 class="settings-title">Settings</h2>
                <div class="toggle-container">
                    <span class="toggle-label">Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">Language (UI)</span>
                    <select id="languageSelect" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border-color);">
                        <option value="en">English</option>
                        <option value="hi">Hindi</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-title">About School</h2>
                <div class="info-section">
                    <div class="info-title">Mill Karwaan Public School, Balrampur</div>
                    <p><strong>Principal:</strong> Md Arshad Alig</p>
                    <p><strong>Contact:</strong> 9758919151</p>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-title">About Dev</h2>
                <div class="info-section">
                    <div class="info-title">Created by Abutalha ‚Äî Proud Student of MKPS üéì</div>
                    <p>Genius Developer | AI Enthusiast | Future Tech Leader</p>
                    <p><strong>Contact:</strong> 9839469669</p>
                    <p>"Built with love for my school!"</p>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-title">Terms & Conditions</h2>
                <p>Milli AI is designed to assist students with their studies. Please use responsibly and for educational purposes only.</p>
                <p>Do not use for cheating or any unethical activities.</p>
                <p>The school and developer are not responsible for any misuse of this tool.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        Designed for MKPS by Abutalha ‚ù§Ô∏è
    </div>

    <script>
        // DOM Elements
        const landingScreen = document.getElementById('landingScreen');
        const chatContainer = document.getElementById('chatContainer');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const stopBtn = document.getElementById('stopBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const startChatBtn = document.getElementById('startChatBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettings = document.getElementById('closeSettings');
        const settingsModal = document.getElementById('settingsModal');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const languageSelect = document.getElementById('languageSelect');
        const notificationsBtn = document.getElementById('notificationsBtn');
        const notificationCount = document.getElementById('notificationCount');
        const maintenanceBanner = document.getElementById('maintenanceBanner');
        const attachmentBtn = document.querySelector('.attachment-btn');

        // Disable attachment button for now
        attachmentBtn.style.opacity = '0.5';
        attachmentBtn.title = 'Upload file (coming soon)';
        attachmentBtn.addEventListener('click', function() {
            alert('File upload feature coming soon!');
        });

        // Chat state
        let isGenerating = false;
        let currentAbortController = null;
        let chats = [];
        let currentChatId = null;
        let notificationData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadChats();
            checkMaintenanceMode();
            setupEventListeners();
            setupLanguageDetection();
        });

        function setupEventListeners() {
            // Start chat button
            startChatBtn.addEventListener('click', startNewChat);
            
            // Send message
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Stop generation
            stopBtn.addEventListener('click', stopGeneration);
            
            // New chat button
            newChatBtn.addEventListener('click', startNewChat);
            
            // Settings
            settingsBtn.addEventListener('click', function() {
                settingsModal.style.display = 'flex';
            });
            
            closeSettings.addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });
            
            // Dark mode toggle
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
            });
            
            // Language select
            languageSelect.addEventListener('change', function() {
                localStorage.setItem('uiLanguage', this.value);
                // In a real app, we would update UI language here
                alert('Language setting saved. Refresh page to see changes.');
            });
            
            // Notifications
            notificationsBtn.addEventListener('click', showNotifications);
            
            // Close settings when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                // Close all chat menus when clicking outside
                document.querySelectorAll('.chat-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            });
            
            // Hide menus when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dot-menu')) {
                    document.querySelectorAll('.chat-menu').forEach(menu => {
                        menu.classList.remove('active');
                    });
                }
            });
        }

        function setupLanguageDetection() {
            // Simple language detection based on browser language
            const userLang = navigator.language || navigator.userLanguage;
            if (userLang.startsWith('hi')) {
                languageSelect.value = 'hi';
            }
            localStorage.setItem('uiLanguage', languageSelect.value);
        }

        function startNewChat() {
            landingScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            messagesContainer.innerHTML = '';
            currentChatId = Date.now().toString();
            
            // Add welcome message
            addAIMessage("Hello! I'm Milli AI, your study assistant from MKPS Balrampur! How can I help you with your studies today? üòä");
            
            // Create new chat in storage
            const newChat = {
                id: currentChatId,
                title: 'New Chat',
                messages: [],
                archived: false,
                createdAt: new Date().toISOString()
            };
            chats.push(newChat);
            saveChats();
            
            // Scroll to bottom
            scrollToBottom();
        }

        async function sendMessage() {
            if (isGenerating) return;
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Clear input
            messageInput.value = '';
            
            // Add user message
            addUserMessage(message);
            
            // Check if user wants to generate image
            if (message.toLowerCase().includes('generate image for') || message.toLowerCase().includes('create image for')) {
                await generateImage(message);
                return;
            }
            
            // Start generation
            isGenerating = true;
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            
            // Create abort controller for this request
            currentAbortController = new AbortController();
            
            try {
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.innerHTML = `
                    <div class="message-header">
                        <strong>Milli AI</strong> ‚Ä¢ ${getCurrentDateTime()}
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="loading"></div> Thinking...
                    </div>
                `;
                messagesContainer.appendChild(loadingDiv);
                scrollToBottom();
                
                // Detect if question is study-related
                const isStudyRelated = isStudyQuestion(message);
                
                let response;
                if (!isStudyRelated) {
                    response = "I'm designed to help with study topics. Try asking about Science, Math, History etc. üòä";
                } else {
                    // Try primary Gemini API first
                    response = await callGeminiAPI(message, currentAbortController.signal);
                    
                    // If failed, try fallback
                    if (!response) {
                        response = await callGeminiAPI(message, currentAbortController.signal, true);
                    }
                    
                    if (!response) {
                        response = "Sorry, I'm having trouble connecting to the AI service right now. Please try again later.";
                    }
                }
                
                // Remove loading indicator
                messagesContainer.removeChild(loadingDiv);
                
                // Add AI response
                addAIMessage(response);
                
                // Add suggestion
                addSuggestion();
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Generation cancelled');
                } else {
                    console.error('Error:', error);
                    messagesContainer.removeChild(loadingDiv);
                    addAIMessage("Sorry, I encountered an error. Please try again.");
                }
            } finally {
                isGenerating = false;
                sendBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                currentAbortController = null;
            }
        }

        function stopGeneration() {
            if (currentAbortController) {
                currentAbortController.abort();
                isGenerating = false;
                sendBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>You</strong> ‚Ä¢ ${getCurrentDateTime()}
                </div>
                ${text}
            `;
            messagesContainer.appendChild(messageDiv);
            
            // Save to current chat
            if (currentChatId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages.push({
                        role: 'user',
                        content: text,
                        timestamp: new Date().toISOString()
                    });
                    saveChats();
                }
            }
            
            scrollToBottom();
        }

        function addAIMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            // Create message content
            let messageContent = `
                <div class="message-header">
                    <strong>Milli AI</strong> ‚Ä¢ ${getCurrentDateTime()}
                    <span class="dot-menu" onclick="toggleChatMenu(event, '${Date.now()}')">‚ãØ</span>
                </div>
                ${text}
            `;
            
            messageDiv.innerHTML = messageContent;
            
            // Add message actions
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            actionsDiv.innerHTML = `
                <button class="action-btn" title="Copy" onclick="copyMessage(this)">üìã</button>
                <button class="action-btn" title="Regenerate" onclick="regenerateMessage(this)">üîÑ</button>
                <button class="action-btn" title="Like" onclick="likeMessage(this)">üëç</button>
                <button class="action-btn" title="Dislike" onclick="dislikeMessage(this)">üëé</button>
                <button class="action-btn" title="Share" onclick="shareMessage(this)">üì§</button>
            `;
            messageDiv.appendChild(actionsDiv);
            
            messagesContainer.appendChild(messageDiv);
            
            // Save to current chat
            if (currentChatId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages.push({
                        role: 'ai',
                        content: text,
                        timestamp: new Date().toISOString()
                    });
                    saveChats();
                }
            }
            
            scrollToBottom();
        }

        function addSuggestion() {
            const suggestions = [
                "--- Try asking: 'Explain Newton's Laws' or 'Generate image for photosynthesis'",
                "--- Want to test your knowledge? Ask me for a quiz on this topic!",
                "--- Need more details? Try asking follow-up questions.",
                "--- Want an image to help visualize this concept? Just ask!",
                "--- Try asking: 'Give me examples' or 'Show me a diagram'"
            ];
            
            const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'message ai-message suggestion';
            suggestionDiv.innerHTML = `
                <div class="message-header">
                    <strong>Milli AI</strong> ‚Ä¢ ${getCurrentDateTime()}
                </div>
                ${randomSuggestion}
            `;
            messagesContainer.appendChild(suggestionDiv);
            scrollToBottom();
        }

        async function generateImage(prompt) {
            try {
                addAIMessage("‚è≥ Generating image...");
                
                const cleanPrompt = prompt.replace(/generate image for|create image for/gi, '').trim();
                
                let submitRes = await fetch("https://stablehorde.net/api/v2/generate/async", {
                    method: "POST",
                    headers: {
                        "apikey": "4y9VQUFr3wiwNJOOnnuh1w",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        prompt: cleanPrompt,
                        params: { steps: 20, width: 512, height: 512 },
                        nsfw: false
                    })
                });
                
                let submitData = await submitRes.json();
                if (!submitRes.ok) {
                    addAIMessage("‚ùå Error: " + submitData.message);
                    return;
                }
                
                const jobId = submitData.id;
                
                let imageUrl = null;
                let attempts = 0;
                const maxAttempts = 12; // 60 seconds max (5 sec intervals)
                
                while (!imageUrl && attempts < maxAttempts) {
                    await new Promise(r => setTimeout(r, 5000));
                    let checkRes = await fetch(`https://stablehorde.net/api/v2/generate/status/${jobId}`);
                    let checkData = await checkRes.json();
                    
                    if (checkData.done && checkData.generations.length > 0) {
                        imageUrl = checkData.generations[0].img;
                        break;
                    }
                    attempts++;
                }
                
                if (imageUrl) {
                    // Remove the "Generating image..." message
                    const messages = messagesContainer.querySelectorAll('.message');
                    messagesContainer.removeChild(messages[messages.length - 1]);
                    
                    // Add the image
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'message ai-message';
                    imageDiv.innerHTML = `
                        <div class="message-header">
                            <strong>Milli AI</strong> ‚Ä¢ ${getCurrentDateTime()}
                            <span class="dot-menu" onclick="toggleChatMenu(event, '${Date.now()}')">‚ãØ</span>
                        </div>
                        <div class="image-container">
                            <img src="${imageUrl}" alt="Generated image for ${cleanPrompt}" class="generated-image">
                            <div class="image-actions">
                                <button class="image-btn" onclick="downloadImage('${imageUrl}', '${cleanPrompt}')">Download</button>
                                <button class="image-btn" onclick="openImagePreview('${imageUrl}')">Full Preview</button>
                                <button class="image-btn" onclick="shareImage('${imageUrl}')">Share</button>
                            </div>
                        </div>
                    `;
                    
                    // Add message actions
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    actionsDiv.innerHTML = `
                        <button class="action-btn" title="Copy" onclick="copyMessage(this)">üìã</button>
                        <button class="action-btn" title="Regenerate" onclick="regenerateMessage(this)">üîÑ</button>
                        <button class="action-btn" title="Like" onclick="likeMessage(this)">üëç</button>
                        <button class="action-btn" title="Dislike" onclick="dislikeMessage(this)">üëé</button>
                        <button class="action-btn" title="Share" onclick="shareMessage(this)">üì§</button>
                    `;
                    imageDiv.appendChild(actionsDiv);
                    
                    messagesContainer.appendChild(imageDiv);
                    
                    // Add suggestion
                    addSuggestion();
                } else {
                    // Remove the "Generating image..." message
                    const messages = messagesContainer.querySelectorAll('.message');
                    messagesContainer.removeChild(messages[messages.length - 1]);
                    addAIMessage("‚ùå Sorry, I couldn't generate the image. Please try again later.");
                }
                
            } catch (error) {
                console.error('Image generation error:', error);
                addAIMessage("‚ùå Error generating image: " + error.message);
            }
        }

        async function callGeminiAPI(prompt, signal, useFallback = false) {
            const apiKey = useFallback ? "AIzaSyCqGS8gb5kh7Jr0pv8d84LxCLhgHU-O_VU" : "AIzaSyB4xCisV5WXwLKpBgh75ZWk1JaZdMptoQs";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are Milli AI, a study assistant for Mill Karwaan Public School, Balrampur. Respond helpfully and concisely to this question: ${prompt}`
                            }]
                        }]
                    }),
                    signal: signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error;
                }
                console.error('Gemini API error:', error);
                return null;
            }
        }

        function isStudyQuestion(question) {
            const studyKeywords = [
                'math', 'maths', 'science', 'history', 'geography', 'english', 'hindi', 'physics', 
                'chemistry', 'biology', 'algebra', 'geometry', 'calculus', 'literature', 'grammar', 
                'explain', 'define', 'what is', 'how to', 'why does', 'solve', 'problem', 'equation', 
                'formula', 'theorem', 'law', 'principle', 'concept', 'theory', 'experiment', 'project',
                'homework', 'assignment', 'test', 'exam', 'quiz', 'study', 'learn', 'understand',
                'chapter', 'lesson', 'topic', 'subject', 'class', 'grade', 'school', 'education'
            ];
            
            const lowerQuestion = question.toLowerCase();
            return studyKeywords.some(keyword => lowerQuestion.includes(keyword));
        }

        function getCurrentDateTime() {
            const now = new Date();
            const options = { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return now.toLocaleDateString('en-US', options);
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function saveChats() {
            localStorage.setItem('milliAI_chats', JSON.stringify(chats));
        }

        function loadChats() {
            const savedChats = localStorage.getItem('milliAI_chats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
            }
            
            // Load dark mode setting
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }
            
            // Load language setting
            const savedLanguage = localStorage.getItem('uiLanguage');
            if (savedLanguage) {
                languageSelect.value = savedLanguage;
            }
        }

        function checkMaintenanceMode() {
            // In a real app, this would check with Firebase
            // For demo, we'll simulate maintenance mode being off
            maintenanceBanner.style.display = 'none';
        }

        function showNotifications() {
            // In a real app, this would fetch from Firebase
            // For demo, show a simple alert
            alert('Notifications feature would connect to Firebase here.\n\nIn a real implementation, this would show school announcements, holidays, and system updates.');
        }

        // Global functions for message actions
        function copyMessage(btn) {
            const messageDiv = btn.closest('.message');
            const messageText = messageDiv.innerText;
            
            navigator.clipboard.writeText(messageText).then(() => {
                alert('Message copied to clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }

        function regenerateMessage(btn) {
            const messageDiv = btn.closest('.message');
            // In a real app, we would regenerate the response
            alert('Regenerate feature would resend the previous prompt to get a new response.');
        }

        function likeMessage(btn) {
            btn.textContent = 'üëç Liked';
            btn.style.color = 'green';
            // In a real app, this would send feedback to the server
        }

        function dislikeMessage(btn) {
            btn.textContent = 'üëé Disliked';
            btn.style.color = 'red';
            // In a real app, this would send feedback to the server
        }

        function shareMessage(btn) {
            const messageDiv = btn.closest('.message');
            const messageText = messageDiv.innerText;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Milli AI Response',
                    text: messageText,
                }).catch(err => {
                    console.error('Error sharing:', err);
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(messageText).then(() => {
                    alert('Message copied to clipboard! You can paste it anywhere to share.');
                });
            }
        }

        function downloadImage(imageUrl, prompt) {
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = `milli-ai-${prompt.replace(/\s+/g, '-').substring(0, 30)}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function openImagePreview(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        function shareImage(imageUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Generated Image from Milli AI',
                    url: imageUrl,
                }).catch(err => {
                    console.error('Error sharing:', err);
                });
            } else {
                navigator.clipboard.writeText(imageUrl).then(() => {
                    alert('Image URL copied to clipboard! You can paste it anywhere to share.');
                });
            }
        }

        function toggleChatMenu(event, chatId) {
            event.stopPropagation();
            const menu = document.querySelector('.chat-menu');
            
            if (menu) {
                menu.classList.toggle('active');
            } else {
                // Create menu if it doesn't exist
                const menuDiv = document.createElement('div');
                menuDiv.className = 'chat-menu';
                menuDiv.innerHTML = `
                    <div class="menu-item" onclick="renameChat('${chatId}')">‚úèÔ∏è Rename</div>
                    <div class="menu-item" onclick="deleteChat('${chatId}')">üóëÔ∏è Delete</div>
                    <div class="menu-item" onclick="archiveChat('${chatId}')">üì¶ Archive</div>
                    <div class="menu-item" onclick="shareChat('${chatId}')">üì§ Share</div>
                `;
                event.target.parentElement.appendChild(menuDiv);
                menuDiv.classList.add('active');
            }
        }

        function renameChat(chatId) {
            const newName = prompt('Enter new name for this chat:');
            if (newName && newName.trim()) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.title = newName.trim();
                    saveChats();
                    alert('Chat renamed successfully!');
                }
            }
        }

        function deleteChat(chatId) {
            if (confirm('Are you sure you want to delete this chat?')) {
                chats = chats.filter(c => c.id !== currentChatId);
                saveChats();
                alert('Chat deleted successfully!');
                // Go back to landing screen
                landingScreen.style.display = 'flex';
                chatContainer.style.display = 'none';
            }
        }

        function archiveChat(chatId) {
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.archived = true;
                saveChats();
                alert('Chat archived successfully!');
                // Go back to landing screen
                landingScreen.style.display = 'flex';
                chatContainer.style.display = 'none';
            }
        }

        function shareChat(chatId) {
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                const chatText = chat.messages.map(m => `${m.role === 'user' ? 'You' : 'Milli AI'}: ${m.content}`).join('\n\n');
                
                if (navigator.share) {
                    navigator.share({
                        title: `Chat: ${chat.title}`,
                        text: chatText,
                    }).catch(err => {
                        console.error('Error sharing:', err);
                    });
                } else {
                    navigator.clipboard.writeText(chatText).then(() => {
                        alert('Chat content copied to clipboard! You can paste it anywhere to share.');
                    });
                }
            }
        }
    </script>
</body>
</html>
