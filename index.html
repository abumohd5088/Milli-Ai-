<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h2 { color: #333; }
    #notifList li { margin: 5px 0; }
    .maint { background: #ffdddd; padding: 10px; margin-bottom: 15px; border-radius: 8px; }
    .chat { border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 8px; max-width: 80%; }
    .ai { background: #eef; }
    .user { background: #efe; align-self: flex-end; }
    #chatBox { display: flex; flex-direction: column; }
    input, button { padding: 8px; margin: 5px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, collection, doc, setDoc, updateDoc, increment, getDoc, onSnapshot, query, orderBy, limit 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB0fHtqeoerlckQ2RXx_VC86cZz_BJaIIU",
      authDomain: "mkps-balrampur.firebaseapp.com",
      projectId: "mkps-balrampur",
      storageBucket: "mkps-balrampur.appspot.com",
      messagingSenderId: "469227187804",
      appId: "1:469227187804:web:8abdb9b75ed05b7eadc099"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // üîê Anonymous login
    signInAnonymously(auth).catch(err => console.error("Auth error:", err));

    // üîî Notifications realtime
    onSnapshot(collection(db, "notifications"), (snap) => {
      const list = document.getElementById("notifList");
      list.innerHTML = "";
      snap.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = data.title + ": " + data.message;
        list.appendChild(li);
      });
    });

    // üõ† Maintenance realtime
    onSnapshot(doc(db, "system", "maintenance"), (snap) => {
      const box = document.getElementById("maintBox");
      if (snap.exists() && snap.data().active) {
        box.innerText = "‚ö†Ô∏è The system is under maintenance.";
        box.style.display = "block";
      } else {
        box.style.display = "none";
      }
    });

    // üìä Stats realtime (Top 5)
    const statsList = document.getElementById("statsList");
    const statsQuery = query(collection(db, "stats"), orderBy("count", "desc"), limit(5));
    onSnapshot(statsQuery, (snap) => {
      statsList.innerHTML = "";
      if (snap.empty) {
        statsList.innerHTML = "<li>No stats yet</li>";
      } else {
        snap.forEach(doc => {
          const data = doc.data();
          const li = document.createElement("li");
          li.textContent = `${data.question} ‚Üí ${data.count} times`;
          statsList.appendChild(li);
        });
      }
    });

    // ü§ñ Gemini API Key
    const GEMINI_API_KEY = "AIzaSyB4xCisV5WXwLKpBgh75ZWk1JaZdMptoQs";

    // üöÄ Ask AI
    async function askAI() {
      const q = document.getElementById("question").value.trim();
      if (!q) return;

      const chatBox = document.getElementById("chatBox");
      const userMsg = document.createElement("div");
      userMsg.className = "chat user";
      userMsg.innerText = "You: " + q;
      chatBox.appendChild(userMsg);

      // save stats
      const ref = doc(db, "stats", q.toLowerCase());
      const snap = await getDoc(ref);
      if (snap.exists()) {
        await updateDoc(ref, { count: increment(1) });
      } else {
        await setDoc(ref, { question: q, count: 1 });
      }

      // show typing...
      const aiMsg = document.createElement("div");
      aiMsg.className = "chat ai";
      aiMsg.innerText = "AI: typing...";
      chatBox.appendChild(aiMsg);

      try {
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ role: "user", parts: [{ text: q }] }]
            })
          }
        );

        const data = await res.json();
        console.log("Gemini response:", data);

        let answer = "‚ö†Ô∏è No response from AI";
        if (data?.candidates?.[0]?.content?.parts?.[0]?.text) {
          answer = data.candidates[0].content.parts[0].text;
        }
        aiMsg.innerText = "AI: " + answer;
      } catch (err) {
        console.error("AI error:", err);
        aiMsg.innerText = "‚ö†Ô∏è API Error: " + err.message;
      }

      document.getElementById("question").value = "";
    }
    window.askAI = askAI;
  </script>
</head>
<body>
  <h2>ü§ñ AI Assistant</h2>
  <div id="maintBox" class="maint" style="display:none;"></div>

  <div>
    <input type="text" id="question" placeholder="Type your question..." style="width:70%;">
    <button onclick="askAI()">Ask</button>
  </div>

  <div id="chatBox"></div>

  <h3>üîî Notifications</h3>
  <ul id="notifList"></ul>

  <h3>üìä Top Asked Questions</h3>
  <ul id="statsList"><li>Loading...</li></ul>
</body>
</html>
