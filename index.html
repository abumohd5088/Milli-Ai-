<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milli AI - MKPS Balrampur</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 180px);
        }
        @media (max-width: 640px) {
            .chat-container {
                height: calc(100vh - 160px);
            }
        }
        .typing-indicator:after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            z-index: 10;
        }
        .dropdown.active {
            display: block;
        }
        .message-options {
            display: none;
        }
        .message:hover .message-options {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB0fHtqeoerlckQ2RXx_VC86cZz_BJaIIU",
            authDomain: "mkps-balrampur.firebaseapp.com",
            projectId: "mkps-balrampur",
            storageBucket: "mkps-balrampur.appspot.com",
            messagingSenderId: "469227187804",
            appId: "1:469227187804:web:8abdb9b75ed05b7eadc099"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const messaging = firebase.messaging();
    </script>

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-blue-600 dark:bg-blue-800 text-white p-4 shadow-md">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <img src="http://static.photos/education/200x200/1" alt="MKPS Logo" class="w-10 h-10 rounded-full">
                    <h1 class="text-xl font-bold">Milli AI</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="notificationBtn" class="relative p-2 rounded-full hover:bg-blue-700 dark:hover:bg-blue-900">
                            <i data-feather="bell"></i>
                            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notificationDropdown" class="dropdown bg-white dark:bg-gray-800 shadow-lg rounded-md mt-2 w-64 max-h-96 overflow-y-auto">
                            <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="font-semibold">Notifications</h3>
                            </div>
                            <div id="notificationList" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <div class="p-3 text-center text-gray-500">No new notifications</div>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="settingsBtn" class="p-2 rounded-full hover:bg-blue-700 dark:hover:bg-blue-900">
                            <i data-feather="settings"></i>
                        </button>
                        <div id="settingsDropdown" class="dropdown bg-white dark:bg-gray-800 shadow-lg rounded-md mt-2 w-48">
                            <div class="py-1">
                                <button id="themeToggle" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                    <i data-feather="moon" class="mr-2"></i> Dark Mode
                                </button>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                    <i data-feather="globe" class="mr-2"></i> Language
                                </button>
                                <button id="aboutSchoolBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                    <i data-feather="info" class="mr-2"></i> About School
                                </button>
                                <button id="aboutDevBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                    <i data-feather="code" class="mr-2"></i> About Developer
                                </button>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                    <i data-feather="file-text" class="mr-2"></i> Terms & Conditions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar (hidden on mobile) -->
        <div class="flex flex-1 overflow-hidden">
            <aside class="hidden md:block w-64 bg-gray-100 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 p-4 overflow-y-auto">
                <div class="mb-4">
                    <button id="newChatBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md flex items-center justify-center">
                        <i data-feather="plus" class="mr-2"></i> New Chat
                    </button>
                </div>
                <div class="space-y-2">
                    <div id="chatList" class="space-y-1">
                        <!-- Chats will be loaded here -->
                    </div>
                </div>
            </aside>

            <!-- Main Chat Area -->
            <main class="flex-1 flex flex-col">
                <!-- Chat Header (mobile) -->
                <div class="md:hidden bg-gray-100 dark:bg-gray-800 p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <button id="mobileMenuBtn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i data-feather="menu"></i>
                    </button>
                    <h2 id="currentChatTitle" class="text-lg font-semibold">New Chat</h2>
                    <div class="w-8"></div> <!-- Spacer for alignment -->
                </div>

                <!-- Chat Container -->
                <div id="chatContainer" class="chat-container overflow-y-auto p-4 space-y-4 flex-1">
                    <!-- Welcome Message -->
                    <div class="text-center py-10">
                        <img src="http://static.photos/technology/200x200/1" alt="Milli AI" class="w-20 h-20 mx-auto rounded-full mb-4">
                        <h2 class="text-2xl font-bold mb-2">Welcome to Milli AI</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Ask me anything about studies from Mill Karwaan Public School, Balrampur</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-2xl mx-auto">
                            <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                "Explain Newton's Laws of Motion"
                            </button>
                            <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                "What's the syllabus for Class 10 Science?"
                            </button>
                            <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                "Help me with algebra problems"
                            </button>
                            <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                "Generate an image of the solar system"
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                    <div class="flex items-center space-x-2">
                        <button id="attachBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-feather="paperclip"></i>
                        </button>
                        <div class="flex-1 relative">
                            <textarea id="messageInput" rows="1" class="w-full border border-gray-300 dark:border-gray-600 rounded-full py-2 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none bg-white dark:bg-gray-900" placeholder="Ask me anything about study..."></textarea>
                            <button id="sendBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 rounded-full text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
                                <i data-feather="send"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">Milli AI may produce inaccurate information. Always verify important information.</p>
                </div>
            </main>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileSidebar" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden">
            <div class="absolute left-0 top-0 bottom-0 w-64 bg-gray-100 dark:bg-gray-800 p-4 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Chats</h3>
                    <button id="closeMobileMenuBtn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <button id="newChatBtnMobile" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md flex items-center justify-center">
                        <i data-feather="plus" class="mr-2"></i> New Chat
                    </button>
                </div>
                <div id="mobileChatList" class="space-y-1">
                    <!-- Mobile chat list will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="aboutSchoolModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">About Mill Karwaan Public School</h3>
                    <button class="close-modal p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <img src="http://static.photos/education/640x360/1" alt="MKPS" class="w-full h-48 object-cover rounded-md mb-4">
                <p class="mb-2"><strong>Name:</strong> Mill Karwaan Public School, Balrampur (MKPS)</p>
                <p class="mb-2"><strong>Principal:</strong> Md Arshad Alig</p>
                <p class="mb-4"><strong>Contact:</strong> 9758919151</p>
                <p class="text-gray-700 dark:text-gray-300">MKPS is committed to providing quality education with modern teaching methodologies and a focus on holistic development of students.</p>
            </div>
        </div>

        <div id="aboutDevModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">About Developer</h3>
                    <button class="close-modal p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <img src="http://static.photos/people/200x200/1" alt="Developer" class="w-20 h-20 rounded-full mx-auto mb-4">
                <p class="mb-2"><strong>Name:</strong> Abutalha</p>
                <p class="mb-2"><strong>School:</strong> Mill Karwaan Public School (Student)</p>
                <p class="mb-4"><strong>Contact:</strong> 9839469669</p>
                <p class="text-gray-700 dark:text-gray-300">Abutalha is a talented student developer with a passion for creating innovative solutions to enhance the learning experience at MKPS. His dedication to combining technology with education has resulted in this advanced AI assistant for the school community.</p>
            </div>
        </div>

        <div id="imagePreviewModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Image Preview</h3>
                    <button class="close-modal p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <img id="previewedImage" src="" alt="Preview" class="w-full h-auto rounded-md mb-4">
                <div class="flex space-x-2 justify-center">
                    <button id="downloadImageBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md flex items-center">
                        <i data-feather="download" class="mr-2"></i> Download
                    </button>
                    <button id="shareImageBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 py-2 px-4 rounded-md flex items-center">
                        <i data-feather="share-2" class="mr-2"></i> Share
                    </button>
                    <button id="regenerateImageBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 py-2 px-4 rounded-md flex items-center">
                        <i data-feather="refresh-cw" class="mr-2"></i> Regenerate
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Initialize AOS and Feather Icons
            AOS.init();
            feather.replace();

            // DOM Elements
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatContainer = document.getElementById('chatContainer');
            const newChatBtn = document.getElementById('newChatBtn');
            const newChatBtnMobile = document.getElementById('newChatBtnMobile');
            const chatList = document.getElementById('chatList');
            const mobileChatList = document.getElementById('mobileChatList');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const closeMobileMenuBtn = document.getElementById('closeMobileMenuBtn');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const currentChatTitle = document.getElementById('currentChatTitle');
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationList = document.getElementById('notificationList');
            const notificationCount = document.getElementById('notificationCount');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsDropdown = document.getElementById('settingsDropdown');
            const themeToggle = document.getElementById('themeToggle');
            const aboutSchoolBtn = document.getElementById('aboutSchoolBtn');
            const aboutDevBtn = document.getElementById('aboutDevBtn');
            const aboutSchoolModal = document.getElementById('aboutSchoolModal');
            const aboutDevModal = document.getElementById('aboutDevModal');
            const imagePreviewModal = document.getElementById('imagePreviewModal');
            const previewedImage = document.getElementById('previewedImage');
            const downloadImageBtn = document.getElementById('downloadImageBtn');
            const shareImageBtn = document.getElementById('shareImageBtn');
            const regenerateImageBtn = document.getElementById('regenerateImageBtn');
            const attachBtn = document.getElementById('attachBtn');
            const suggestionBtns = document.querySelectorAll('.suggestion-btn');

            // Chat state
            let chats = JSON.parse(localStorage.getItem('milliAiChats')) || [];
            let currentChatId = null;
            let isGenerating = false;

            // Initialize the app
            function init() {
                loadChats();
                setupEventListeners();
                checkDarkModePreference();
                setupFirebaseListeners();
                
                // If no chats exist, create a default one
                if (chats.length === 0) {
                    createNewChat();
                } else {
                    loadChat(chats[0].id);
                }
            }

            // Set up event listeners
            function setupEventListeners() {
                // Message input
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', () => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = (messageInput.scrollHeight) + 'px';
                });

                sendBtn.addEventListener('click', sendMessage);

                // Chat management
                newChatBtn.addEventListener('click', createNewChat);
                newChatBtnMobile.addEventListener('click', createNewChat);

                // Mobile menu
                mobileMenuBtn.addEventListener('click', () => {
                    mobileSidebar.classList.remove('hidden');
                });

                closeMobileMenuBtn.addEventListener('click', () => {
                    mobileSidebar.classList.add('hidden');
                });

                // Dropdowns
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('active');
                    settingsDropdown.classList.remove('active');
                });

                settingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    settingsDropdown.classList.toggle('active');
                    notificationDropdown.classList.remove('active');
                });

                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                        notificationDropdown.classList.remove('active');
                    }
                    if (!settingsBtn.contains(e.target) && !settingsDropdown.contains(e.target)) {
                        settingsDropdown.classList.remove('active');
                    }
                });

                // Theme toggle
                themeToggle.addEventListener('click', toggleDarkMode);

                // Modals
                aboutSchoolBtn.addEventListener('click', () => {
                    aboutSchoolModal.classList.remove('hidden');
                });

                aboutDevBtn.addEventListener('click', () => {
                    aboutDevModal.classList.remove('hidden');
                });

                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        aboutSchoolModal.classList.add('hidden');
                        aboutDevModal.classList.add('hidden');
                        imagePreviewModal.classList.add('hidden');
                    });
                });

                // Suggestion buttons
                suggestionBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        messageInput.value = btn.textContent.trim().replace(/"/g, '');
                        messageInput.focus();
                    });
                });

                // Image buttons
                downloadImageBtn.addEventListener('click', downloadImage);
                shareImageBtn.addEventListener('click', shareImage);
                regenerateImageBtn.addEventListener('click', regenerateImage);
            }

            // Firebase setup
            function setupFirebaseListeners() {
                // Listen for notifications
                db.collection("notifications")
                    .orderBy("timestamp", "desc")
                    .limit(10)
                    .onSnapshot((snapshot) => {
                        const notifications = [];
                        snapshot.forEach(doc => {
                            notifications.push(doc.data());
                        });
                        updateNotifications(notifications);
                    });

                // Check maintenance status
                db.collection("system").doc("maintenance")
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data().isMaintenance) {
                            showMaintenanceAlert(doc.data().message);
                        }
                    });
            }

            function updateNotifications(notifications) {
                notificationList.innerHTML = '';
                
                if (notifications.length === 0) {
                    notificationList.innerHTML = '<div class="p-3 text-center text-gray-500">No new notifications</div>';
                    notificationCount.classList.add('hidden');
                    return;
                }

                notificationCount.textContent = notifications.length;
                notificationCount.classList.remove('hidden');

                notifications.forEach(notif => {
                    const notifElement = document.createElement('div');
                    notifElement.className = 'p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                    notifElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0 pt-0.5">
                                <i data-feather="${notif.type === 'warning' ? 'alert-triangle' : notif.type === 'holiday' ? 'calendar' : 'info'}" class="text-${notif.type === 'warning' ? 'red' : notif.type === 'holiday' ? 'yellow' : 'blue'}-500"></i>
                            </div>
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium">${notif.title}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${notif.message}</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${new Date(notif.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                    notificationList.appendChild(notifElement);
                });
                feather.replace();
            }

            function showMaintenanceAlert(message) {
                const alert = document.createElement('div');
                alert.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-md shadow-lg z-50 flex items-center';
                alert.innerHTML = `
                    <i data-feather="alert-triangle" class="mr-2"></i>
                    <span>${message || 'System is under maintenance. Some features may not work.'}</span>
                `;
                document.body.appendChild(alert);
                feather.replace();
                
                setTimeout(() => {
                    alert.remove();
                }, 10000);
            }

            // Chat functions
            function createNewChat() {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                chats.unshift(newChat);
                saveChats();
                loadChat(newChat.id);
                
                // Close mobile menu if open
                mobileSidebar.classList.add('hidden');
            }

            function loadChats() {
                chatList.innerHTML = '';
                mobileChatList.innerHTML = '';
                
                chats.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                
                chats.forEach(chat => {
                    const chatElement = createChatElement(chat);
                    chatList.appendChild(chatElement.cloneNode(true));
                    mobileChatList.appendChild(chatElement);
                });
                
                feather.replace();
            }

            function createChatElement(chat) {
                const chatElement = document.createElement('div');
                chatElement.className = `group flex items-center justify-between p-2 rounded-md cursor-pointer ${currentChatId === chat.id ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`;
                chatElement.dataset.chatId = chat.id;
                
                chatElement.innerHTML = `
                    <div class="flex items-center truncate flex-1" onclick="loadChat('${chat.id}')">
                        <i data-feather="message-square" class="mr-2 flex-shrink-0"></i>
                        <span class="truncate">${chat.title}</span>
                    </div>
                    <div class="relative">
                        <button class="chat-options-btn p-1 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 opacity-0 group-hover:opacity-100">
                            <i data-feather="more-vertical"></i>
                        </button>
                        <div class="dropdown bg-white dark:bg-gray-800 shadow-lg rounded-md mt-1 w-48">
                            <div class="py-1">
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center rename-chat-btn">
                                    <i data-feather="edit-2" class="mr-2"></i> Rename
                                </button>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center delete-chat-btn">
                                    <i data-feather="trash-2" class="mr-2"></i> Delete
                                </button>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center share-chat-btn">
                                    <i data-feather="share-2" class="mr-2"></i> Share
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners to the buttons
                const chatOptionsBtn = chatElement.querySelector('.chat-options-btn');
                const dropdown = chatElement.querySelector('.dropdown');
                
                chatOptionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('active');
                });
                
                chatElement.querySelector('.rename-chat-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    renameChat(chat.id);
                    dropdown.classList.remove('active');
                });
                
                chatElement.querySelector('.delete-chat-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                    dropdown.classList.remove('active');
                });
                
                chatElement.querySelector('.share-chat-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    shareChat(chat.id);
                    dropdown.classList.remove('active');
                });
                
                return chatElement;
            }

            function loadChat(chatId) {
                const chat = chats.find(c => c.id === chatId);
                if (!chat) return;
                
                currentChatId = chatId;
                currentChatTitle.textContent = chat.title;
                
                // Update chat list UI
                document.querySelectorAll('[data-chat-id]').forEach(el => {
                    if (el.dataset.chatId === chatId) {
                        el.classList.add('bg-blue-100', 'dark:bg-blue-900');
                    } else {
                        el.classList.remove('bg-blue-100', 'dark:bg-blue-900');
                    }
                });
                
                // Clear and rebuild chat container
                chatContainer.innerHTML = '';
                
                if (chat.messages.length === 0) {
                    // Show welcome message if chat is empty
                    chatContainer.innerHTML = `
                        <div class="text-center py-10">
                            <img src="http://static.photos/technology/200x200/1" alt="Milli AI" class="w-20 h-20 mx-auto rounded-full mb-4">
                            <h2 class="text-2xl font-bold mb-2">Welcome to Milli AI</h2>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">Ask me anything about studies from Mill Karwaan Public School, Balrampur</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-2xl mx-auto">
                                <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                    "Explain Newton's Laws of Motion"
                                </button>
                                <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                    "What's the syllabus for Class 10 Science?"
                                </button>
                                <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                    "Help me with algebra problems"
                                </button>
                                <button class="suggestion-btn bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-3 rounded-lg text-left">
                                    "Generate an image of the solar system"
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add event listeners to suggestion buttons
                    document.querySelectorAll('.suggestion-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            messageInput.value = btn.textContent.trim().replace(/"/g, '');
                            messageInput.focus();
                        });
                    });
                } else {
                    // Display all messages
                    chat.messages.forEach(message => {
                        addMessageToChat(message, false);
                    });
                    
                    // Scroll to bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                // Close mobile menu if open
                mobileSidebar.classList.add('hidden');
            }

            function renameChat(chatId) {
                const chat = chats.find(c => c.id === chatId);
                if (!chat) return;
                
                const newTitle = prompt('Enter new chat title:', chat.title);
                if (newTitle && newTitle.trim() !== '') {
                    chat.title = newTitle.trim();
                    chat.updatedAt = new Date().toISOString();
                    saveChats();
                    loadChats();
                    
                    if (currentChatId === chatId) {
                        currentChatTitle.textContent = newTitle.trim();
                    }
                }
            }

            function deleteChat(chatId) {
                if (!confirm('Are you sure you want to delete this chat?')) return;
                
                const chatIndex = chats.findIndex(c => c.id === chatId);
                if (chatIndex === -1) return;
                
                chats.splice(chatIndex, 1);
                saveChats();
                loadChats();
                
                if (currentChatId === chatId) {
                    if (chats.length > 0) {
                        loadChat(chats[0].id);
                    } else {
                        createNewChat();
                    }
                }
            }

            function shareChat(chatId) {
                const chat = chats.find(c => c.id === chatId);
                if (!chat) return;
                
                // In a real app, you would implement actual sharing functionality
                alert(`Share link for "${chat.title}" would be generated here.`);
            }

            function saveChats() {
                localStorage.setItem('milliAiChats', JSON.stringify(chats));
            }

            // Message functions
            function sendMessage() {
                const messageText = messageInput.value.trim();
                if (messageText === '' || isGenerating) return;
                
                const chat = chats.find(c => c.id === currentChatId);
                if (!chat) return;
                
                // Add user message to chat
                const userMessage = {
                    id: Date.now().toString(),
                    text: messageText,
                    sender: 'user',
                    timestamp: new Date().toISOString()
                };
                
                chat.messages.push(userMessage);
                chat.updatedAt = new Date().toISOString();
                chat.title = messageText.length > 30 ? messageText.substring(0, 30) + '...' : messageText;
                saveChats();
                loadChats();
                
                addMessageToChat(userMessage, true);
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Generate AI response
                generateAIResponse(messageText);
            }

            function addMessageToChat(message, scrollToBottom = true) {
                const messageElement = document.createElement('div');
                messageElement.className = `message flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`;
                messageElement.dataset.messageId = message.id;
                
                if (message.sender === 'user') {
                    messageElement.innerHTML = `
                        <div class="max-w-[80%] bg-blue-600 text-white rounded-lg p-3 relative">
                            <div class="message-content">${formatMessageText(message.text)}</div>
                            <div class="message-options absolute -bottom-2 right-2 bg-white dark:bg-gray-800 rounded-full shadow-md flex items-center">
                                <button class="copy-message-btn p-1 text-gray-500 hover:text-blue-500" title="Copy">
                                    <i data-feather="copy" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // AI message
                    let content = formatMessageText(message.text);
                    
                    if (message.imageUrl) {
                        content += `
                            <div class="mt-3">
                                <img src="${message.imageUrl}" alt="Generated image" class="rounded-md cursor-pointer max-w-full h-auto max-h-64 object-cover hover:opacity-90 view-image-btn" data-image-url="${message.imageUrl}">
                                <div class="flex justify-end mt-2 space-x-2">
                                    <button class="like-btn p-1 text-gray-500 hover:text-green-500" title="Like">
                                        <i data-feather="thumbs-up" class="w-4 h-4"></i>
                                    </button>
                                    <button class="dislike-btn p-1 text-gray-500 hover:text-red-500" title="Dislike">
                                        <i data-feather="thumbs-down" class="w-4 h-4"></i>
                                    </button>
                                    <button class="copy-message-btn p-1 text-gray-500 hover:text-blue-500" title="Copy">
                                        <i data-feather="copy" class="w-4 h-4"></i>
                                    </button>
                                    <button class="regenerate-btn p-1 text-gray-500 hover:text-purple-500" title="Regenerate">
                                        <i data-feather="refresh-cw" class="w-4 h-4"></i>
                                    </button>
                                    <button class="share-btn p-1 text-gray-500 hover:text-yellow-500" title="Share">
                                        <i data-feather="share-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                    messageElement.innerHTML = `
                        <div class="max-w-[80%] bg-gray-200 dark:bg-gray-700 rounded-lg p-3 relative">
                            <div class="flex items-center mb-1">
                                <span class="font-semibold text-blue-600 dark:text-blue-400">Milli AI</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">${new Date(message.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="message-content">${content}</div>
                            ${message.suggestions ? `
                                <div class="mt-3 pt-3 border-t border-gray-300 dark:border-gray-600">
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">--- Suggestion ---</p>
                                    <p class="text-sm">${message.suggestions}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                chatContainer.appendChild(messageElement);
                feather.replace();
                
                if (scrollToBottom) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                // Add event listeners to message buttons
                if (message.sender === 'ai') {
                    // Image preview
                    if (message.imageUrl) {
                        document.querySelectorAll('.view-image-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                previewImage(btn.dataset.imageUrl);
                            });
                        });
                    }
                    
                    // Like/dislike buttons
                    document.querySelectorAll('.like-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            alert('Thank you for your feedback!');
                        });
                    });
                    
                    document.querySelectorAll('.dislike-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            alert('We appreciate your feedback and will improve.');
                        });
                    });
                }
                
                // Copy button
                document.querySelectorAll('.copy-message-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const messageContent = btn.closest('.message').querySelector('.message-content').textContent;
                        navigator.clipboard.writeText(messageContent.trim());
                        
                        // Show copied tooltip
                        const tooltip = document.createElement('div');
                        tooltip.className = 'absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded';
                        tooltip.textContent = 'Copied!';
                        btn.appendChild(tooltip);
                        
                        setTimeout(() => {
                            tooltip.remove();
                        }, 2000);
                    });
                });
                
                // Regenerate button
                document.querySelectorAll('.regenerate-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const messageId = btn.closest('.message').dataset.messageId;
                        regenerateResponse(messageId);
                    });
                });
                
                // Share button
                document.querySelectorAll('.share-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const messageContent = btn.closest('.message').querySelector('.message-content').textContent;
                        shareContent(messageContent.trim());
                    });
                });
            }

            function formatMessageText(text) {
                // Simple formatting for links and line breaks
                return text
                    .replace(/\n/g, '<br>')
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 hover:underline">$1</a>');
            }

            async function generateAIResponse(prompt) {
                isGenerating = true;
                
                const chat = chats.find(c => c.id === currentChatId);
                if (!chat) return;
                
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message flex justify-start';
                typingIndicator.innerHTML = `
                    <div class="max-w-[80%] bg-gray-200 dark:bg-gray-700 rounded-lg p-3">
                        <div class="flex items-center">
                            <span class="font-semibold text-blue-600 dark:text-blue-400">Milli AI</span>
                            <span class="typing-indicator ml-2"></span>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(typingIndicator);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                try {
                    // Check if the prompt is study-related
                    const isStudyRelated = checkStudyRelated(prompt);
                    
                    if (!isStudyRelated) {
                        // For non-study related queries
                        const responseMessage = {
                            id: Date.now().toString(),
                            text: "I'm designed specifically to help with study-related questions from Mill Karwaan Public School. Please ask me about your studies, syllabus, or any academic topics.",
                            sender: 'ai',
                            timestamp: new Date().toISOString(),
                            suggestions: "You might want to ask about: 'What's today's homework?' or 'Explain photosynthesis'"
                        };
                        
                        chat.messages.push(responseMessage);
                        chat.updatedAt = new Date().toISOString();
                        saveChats();
                        
                        typingIndicator.remove();
                        addMessageToChat(responseMessage, true);
                        isGenerating = false;
                        return;
                    }
                    
                    // Check if the user is asking for an image
                    const wantsImage = prompt.toLowerCase().includes('image') || 
                                      prompt.toLowerCase().includes('picture') || 
                                      prompt.toLowerCase().includes('generate') ||
                                      prompt.toLowerCase().includes('show me');
                    
                    if (wantsImage) {
                        // Generate image
                        const imageUrl = await generateImage(prompt);
                        
                        if (imageUrl) {
                            const responseMessage = {
                                id: Date.now().toString(),
                                text: `Here's the image you requested based on: "${prompt}"`,
                                sender: 'ai',
                                timestamp: new Date().toISOString(),
                                imageUrl: imageUrl,
                                suggestions: "Would you like me to generate another image with different parameters?"
                            };
                            
                            chat.messages.push(responseMessage);
                            chat.updatedAt = new Date().toISOString();
                            saveChats();
                            
                            typingIndicator.remove();
                            addMessageToChat(responseMessage, true);
                        } else {
                            const responseMessage = {
                                id: Date.now().toString(),
                                text: "I couldn't generate the image at this time. Please try again later.",
                                sender: 'ai',
                                timestamp: new Date().toISOString()
                            };
                            
                            chat.messages.push(responseMessage);
                            chat.updatedAt = new Date().toISOString();
                            saveChats();
                            
                            typingIndicator.remove();
                            addMessageToChat(responseMessage, true);
                        }
                    } else {
                        // Generate text response using Gemini API
                        const responseText = await generateTextResponse(prompt);
                        
                        const responseMessage = {
                            id: Date.now().toString(),
                            text: responseText,
                            sender: 'ai',
                            timestamp: new Date().toISOString(),
                            suggestions: getRandomSuggestion(prompt)
                        };
                        
                        chat.messages.push(responseMessage);
                        chat.updatedAt = new Date().toISOString();
                        saveChats();
                        
                        typingIndicator.remove();
                        addMessageToChat(responseMessage, true);
                    }
                } catch (error) {
                    console.error('Error generating response:', error);
                    
                    const errorMessage = {
                        id: Date.now().toString(),
                        text: "I'm having trouble responding right now. Please try again later.",
                        sender: 'ai',
                        timestamp: new Date().toISOString()
                    };
                    
                    chat.messages.push(errorMessage);
                    chat.updatedAt = new Date().toISOString();
                    saveChats();
                    
                    typingIndicator.remove();
                    addMessageToChat(errorMessage, true);
                }
                
                isGenerating = false;
            }

            function checkStudyRelated(prompt) {
                // Simple check for study-related keywords
                const studyKeywords = [
                    'study', 'homework', 'assignment', 'syllabus', 'exam', 'test', 'question', 
                    'math', 'science', 'history', 'geography', 'physics', 'chemistry', 'biology',
                    'english', 'hindi', 'urdu', 'computer', 'programming', 'algebra', 'geometry',
                    'calculate', 'explain', 'define', 'what is', 'who is', 'when did', 'why does',
                    'how to', 'class', 'lesson', 'chapter', 'subject', 'teacher', 'principal',
                    'school', 'mkps', 'mill karwaan', 'milli', 'education', 'learn', 'teaching'
                ];
                
                const promptLower = prompt.toLowerCase();
                return studyKeywords.some(keyword => promptLower.includes(keyword));
            }

            async function generateTextResponse(prompt) {
                // In a real implementation, you would call the Gemini API here
                // This is a mock implementation for demonstration
                
                // First try with primary API key
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyB4xCisV5WXwLKpBgh75ZWk1JaZdMptoQs`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `You are Milli AI, an assistant for Mill Karwaan Public School, Balrampur. Respond to this study-related query: ${prompt}`
                                }]
                            }]
                        })
                    });
                    
                    if (!response.ok) throw new Error('Primary API failed');
                    
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.log('Primary API failed, trying backup API');
                    
                    // Fallback to backup API key
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyCqGS8gb5kh7Jr0pv8d84LxCLhgHU-O_VU`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `You are Milli AI, an assistant for Mill Karwaan Public School, Balrampur. Respond to this study-related query: ${prompt}`
                                    }]
                                }]
                            })
                        });
                        
                        if (!response.ok) throw new Error('Backup API failed');
                        
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        console.error('Both APIs failed:', error);
                        return "I'm sorry, I'm currently unable to process your request. Please try again later.";
                    }
                }
            }

            async function generateImage(prompt) {
                // In a real implementation, you would call the Stable Horde API here
                // This is a mock implementation for demonstration
                
                try {
                    const submitRes = await fetch("https://stablehorde.net/api/v2/generate/async", {              
                        method: "POST",              
                        headers: {              
                            "apikey": "4y9VQUFr3wiwNJOOnnuh1w",              
                            "Content-Type": "application/json"              
                        },              
                        body: JSON.stringify({              
                            prompt: `Educational illustration of ${prompt}, clean, professional, school-appropriate`,              
                            params: { steps: 20, width: 512, height: 512 },              
                            nsfw: false              
                        })              
                    });              
                            
                    const submitData = await submitRes.json();              
                    if (!submitRes.ok) {              
                        throw new Error(submitData.message);              
                    }              
                            
                    const jobId = submitData.id;              
                    
                    // Poll for result (simplified for demo)
                    await new Promise(r => setTimeout(r, 3000));
                    
                    // In a real app, you would continue polling until the image is ready
                    // For demo purposes, we'll return a placeholder
                    return `http://static.photos/education/512x512/${Math.floor(Math.random() * 100)}`;
                } catch (error) {
                    console.error('Error generating image:', error);
                    return null;
                }
            }

            function getRandomSuggestion(prompt) {
                const suggestions = [
                    "Would you like me to explain this in more detail?",
                    "Should I provide examples related to this topic?",
                    "Would you like me to generate an image to help visualize this?",
                    "Would you like me to summarize the key points?",
                    "Should I create a quiz to test your understanding?",
                    "Would you like me to relate this to your current syllabus?",
                    "Should I provide additional resources on this topic?"
                ];
                
                return suggestions[Math.floor(Math.random() * suggestions.length)];
            }

            function regenerateResponse(messageId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (!chat) return;
                
                const messageIndex = chat.messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1 || messageIndex === 0) return;
                
                // Get the previous user message
                const userMessage = chat.messages[messageIndex - 1];
                if (userMessage.sender !== 'user') return;
                
                // Remove the old AI response
                chat.messages.splice(messageIndex, 1);
                saveChats();
                
                // Remove the message from UI
                document.querySelector(`[data-message-id="${messageId}"]`).remove();
                
                // Generate new response
                generateAIResponse(userMessage.text);
            }

            // Image functions
            function previewImage(imageUrl) {
                previewedImage.src = imageUrl;
                imagePreviewModal.classList.remove('hidden');
            }

            function downloadImage() {
                const link = document.createElement('a');
                link.href = previewedImage.src;
                link.download = `milli-ai-image-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function shareImage() {
                if (navigator.share) {
                    navigator.share({
                        title: 'Image from Milli AI',
                        text: 'Check out this image generated by Milli AI',
                        url: previewedImage.src
                    }).catch(err => {
                        console.log('Error sharing:', err);
                        alert('Sharing failed. Please try another method.');
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    prompt('Copy this link to share the image:', previewedImage.src);
                }
            }

            function regenerateImage() {
                const imageUrl = previewedImage.src;
                const messageElement = document.querySelector(`img[src="${imageUrl}"]`).closest('.message');
                const messageId = messageElement.dataset.messageId;
                
                imagePreviewModal.classList.add('hidden');
                regenerateResponse(messageId);
            }

            function shareContent(content) {
                if (navigator.share) {
                    navigator.share({
                        title: 'Message from Milli AI',
                        text: content,
                        url: window.location.href
                    }).catch(err => {
                        console.log('Error sharing:', err);
                        alert('Sharing failed. Please try another method.');
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    prompt('Copy this text to share:', content);
                }
            }

            // Theme functions
            function checkDarkModePreference() {
                const isDark = localStorage.getItem('darkMode') === 'true' || 
                              (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    themeToggle.innerHTML = '<i data-feather="sun" class="mr-2"></i> Light Mode';
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggle.innerHTML = '<i data-feather="moon" class="mr-2"></i> Dark Mode';
                }
                feather.replace();
            }

            function toggleDarkMode() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
                
                if (isDark) {
                    themeToggle.innerHTML = '<i data-feather="sun" class="mr-2"></i> Light Mode';
                } else {
                    themeToggle.innerHTML = '<i data-feather="moon" class="mr-2"></i> Dark Mode';
                }
                feather.replace();
            }

            // Initialize the app
            init();
        </script>
</body>
</html>
