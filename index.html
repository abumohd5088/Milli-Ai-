<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milli AI - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .form-select {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .btn-primary {
            @apply bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2;
        }
        .btn-secondary {
            @apply bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Header -->
            <div class="bg-blue-600 text-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-bold">Milli AI Admin Panel</h1>
                    <div class="flex items-center space-x-2">
                        <span id="admin-status" class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">Connected</span>
                        <button id="sign-out-btn" class="text-sm bg-white text-blue-600 px-3 py-1 rounded-full hover:bg-blue-50">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="p-6 space-y-8">
                <!-- Send Notification Section -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-lg font-medium mb-4">Send Notification</h2>
                    <form id="notification-form" class="space-y-4">
                        <div>
                            <label for="notification-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="notification-title" class="form-input" required>
                        </div>
                        <div>
                            <label for="notification-message" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                            <textarea id="notification-message" rows="3" class="form-input" required></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="notification-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                <select id="notification-type" class="form-select">
                                    <option value="GENERAL">General</option>
                                    <option value="NEW_FEATURE">New Feature</option>
                                    <option value="WARNING">Warning</option>
                                    <option value="HOLIDAY">Holiday</option>
                                    <option value="URGENT">Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label for="notification-target" class="block text-sm font-medium text-gray-700 mb-1">Target</label>
                                <select id="notification-target" class="form-select">
                                    <option value="all">All Users</option>
                                    <option value="specific">Specific User (by UID)</option>
                                </select>
                            </div>
                        </div>
                        <div id="specific-user-container" class="hidden">
                            <label for="specific-user-uid" class="block text-sm font-medium text-gray-700 mb-1">User UID</label>
                            <input type="text" id="specific-user-uid" class="form-input">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="reset" class="btn-secondary">Clear</button>
                            <button type="submit" class="btn-primary">Send Notification</button>
                        </div>
                    </form>
                </div>
                
                <!-- Maintenance Mode Section -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-lg font-medium mb-4">Maintenance Mode</h2>
                    <form id="maintenance-form" class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="maintenance-active" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="maintenance-active" class="ml-2 block text-sm text-gray-700">Enable Maintenance Mode</label>
                        </div>
                        <div>
                            <label for="maintenance-message" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                            <textarea id="maintenance-message" rows="2" class="form-input" placeholder="Enter maintenance message to display to users"></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="btn-primary">Save Settings</button>
                        </div>
                    </form>
                </div>
                
                <!-- Recent Notifications -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-lg font-medium mb-4">Recent Notifications</h2>
                    <div id="recent-notifications" class="space-y-3">
                        <!-- Notifications will be loaded here -->
                        <div class="text-center py-4 text-gray-500">Loading notifications...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Toast -->
    <div id="success-toast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg">
        <div class="flex items-center">
            <span class="material-icons mr-2">check_circle</span>
            <span id="success-message">Operation completed successfully!</span>
        </div>
    </div>
    
    <!-- Error Toast -->
    <div id="error-toast" class="hidden fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg">
        <div class="flex items-center">
            <span class="material-icons mr-2">error</span>
            <span id="error-message">An error occurred. Please try again.</span>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB0fHtqeoerlckQ2RXx_VC86cZz_BJaIIU",
            authDomain: "mkps-balrampur.firebaseapp.com",
            projectId: "mkps-balrampur",
            storageBucket: "mkps-balrampur.appspot.com",
            messagingSenderId: "469227187804",
            appId: "1:469227187804:web:8abdb9b75ed05b7eadc099"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM Elements
        const notificationForm = document.getElementById('notification-form');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const notificationType = document.getElementById('notification-type');
        const notificationTarget = document.getElementById('notification-target');
        const specificUserContainer = document.getElementById('specific-user-container');
        const specificUserUid = document.getElementById('specific-user-uid');
        const maintenanceForm = document.getElementById('maintenance-form');
        const maintenanceActive = document.getElementById('maintenance-active');
        const maintenanceMessage = document.getElementById('maintenance-message');
        const recentNotifications = document.getElementById('recent-notifications');
        const adminStatus = document.getElementById('admin-status');
        const signOutBtn = document.getElementById('sign-out-btn');
        const successToast = document.getElementById('success-toast');
        const successMessage = document.getElementById('success-message');
        const errorToast = document.getElementById('error-toast');
        const errorMessage = document.getElementById('error-message');
        
        // Admin UID
        const ADMIN_UID = "PEjvSCXzScXA2q0NnVo7CUWnXrj1";
        
        // Initialize the app
        function initApp() {
            // Auto-sign-in as admin
            auth.signInWithEmailAndPassword('madamsir066@gmail.com', 'Talha5088@')
                .then((userCredential) => {
                    if (userCredential.user.uid !== ADMIN_UID) {
                        showError('Unauthorized access. Only admin can use this panel.');
                        auth.signOut();
                        return;
                    }
                    
                    adminStatus.textContent = 'Connected';
                    adminStatus.className = 'text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full';
                    
                    // Load maintenance settings
                    db.collection('system').doc('maintenance').get()
                        .then((doc) => {
                            if (doc.exists) {
                                maintenanceActive.checked = doc.data().active;
                                maintenanceMessage.value = doc.data().message || '';
                            }
                        });
                    
                    // Load recent notifications
                    loadRecentNotifications();
                })
                .catch((error) => {
                    console.error('Admin sign-in error:', error);
                    showError('Failed to authenticate as admin. Please try again.');
                });
        }
        
        function loadRecentNotifications() {
            recentNotifications.innerHTML = '<div class="text-center py-4 text-gray-500">Loading notifications...</div>';
            
            db.collection('notifications')
                .orderBy('timestamp', 'desc')
                .limit(5)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        recentNotifications.innerHTML = '<div class="text-center py-4 text-gray-500">No notifications sent yet.</div>';
                        return;
                    }
                    
                    recentNotifications.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const notification = doc.data();
                        const notificationElement = document.createElement('div');
                        notificationElement.className = 'bg-white p-3 rounded-md border border-gray-200';
                        notificationElement.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium">${notification.title}</h3>
                                    <p class="text-sm text-gray-600">${notification.message}</p>
                                    <p class="text-xs text-gray-500 mt-1">${formatDate(notification.timestamp?.toDate())}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${getNotificationBadgeClass(notification.type)}">
                                    ${getNotificationTypeText(notification.type)}
                                </span>
                            </div>
                            <div class="text-xs mt-2 text-gray-500">
                                Sent to: ${notification.targetUid === 'all' ? 'All Users' : notification.targetUid}
                            </div>
                        `;
                        recentNotifications.appendChild(notificationElement);
                    });
                })
                .catch((error) => {
                    console.error('Error loading notifications:', error);
                    recentNotifications.innerHTML = '<div class="text-center py-4 text-red-500">Failed to load notifications.</div>';
                });
        }
        
        function getNotificationBadgeClass(type) {
            switch(type) {
                case 'NEW_FEATURE': return 'bg-green-100 text-green-800';
                case 'WARNING': return 'bg-yellow-100 text-yellow-800';
                case 'HOLIDAY': return 'bg-blue-100 text-blue-800';
                case 'URGENT': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function getNotificationTypeText(type) {
            switch(type) {
                case 'NEW_FEATURE': return 'New Feature';
                case 'WARNING': return 'Warning';
                case 'HOLIDAY': return 'Holiday';
                case 'URGENT': return 'Urgent';
                default: return 'General';
            }
        }
        
        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleString();
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successToast.classList.remove('hidden');
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorToast.classList.remove('hidden');
            setTimeout(() => {
                errorToast.classList.add('hidden');
            }, 3000);
        }
        
        // Event Listeners
        notificationTarget.addEventListener('change', (e) => {
            specificUserContainer.classList.toggle('hidden', e.target.value !== 'specific');
        });
        
        notificationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = notificationTitle.value.trim();
            const message = notificationMessage.value.trim();
            const type = notificationType.value;
            const target = notificationTarget.value === 'specific' ? specificUserUid.value.trim() : 'all';
            
            if (!title || !message) {
                showError('Please fill in all required fields');
                return;
            }
            
            if (target === 'specific' && !specificUserUid.value.trim()) {
                showError('Please enter a user UID');
                return;
            }
            
            db.collection('notifications').add({
                title,
                message,
                type,
                targetUid: target,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showSuccess('Notification sent successfully!');
                notificationForm.reset();
                loadRecentNotifications();
            })
            .catch((error) => {
                console.error('Error sending notification:', error);
                showError('Failed to send notification');
            });
        });
        
        maintenanceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const active = maintenanceActive.checked;
            const message = maintenanceMessage.value.trim();
            
            db.collection('system').doc('maintenance').set({
                active,
                message: active ? message : '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showSuccess('Maintenance settings updated!');
            })
            .catch((error) => {
                console.error('Error updating maintenance:', error);
                showError('Failed to update maintenance settings');
            });
        });
        
        signOutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.reload();
            });
        });
        
        // Initialize the app
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
