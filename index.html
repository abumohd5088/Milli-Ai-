<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI School Assistant</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    #chat { max-width: 600px; margin: auto; }
    .msg { padding: 10px; margin: 5px 0; border-radius: 5px; }
    .user { background: #d1e7dd; }
    .ai { background: #f8d7da; }
    #notifications, #maintenance, #stats { margin-top: 20px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
  </style>
</head>
<body>
  <h2>📚 AI School Assistant</h2>

  <div id="chat"></div>
  <input id="q" placeholder="Ask something..." style="width:70%; padding:5px;" />
  <button onclick="askAI()">Send</button>

  <div id="notifications"><h3>🔔 Notifications</h3><ul id="notifList"></ul></div>
  <div id="maintenance"><h3>🛠 Maintenance</h3><p id="maintMsg">No active maintenance</p></div>
  <div id="stats"><h3>📊 Stats</h3><div id="statsList">Loading...</div></div>

  <script>
    // 🔥 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB0fHtqeoerlckQ2RXx_VC86cZz_BJaIIU",
      authDomain: "mkps-balrampur.firebaseapp.com",
      projectId: "mkps-balrampur",
      storageBucket: "mkps-balrampur.appspot.com",
      messagingSenderId: "469227187804",
      appId: "1:469227187804:web:8abdb9b75ed05b7eadc099"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 🔑 Gemini API Key
    const GEMINI_API_KEY = "AIzaSyB4xCisV5WXwLKpBgh75ZWk1JaZdMptoQs";

    // Auto login (anonymous)
    auth.signInAnonymously().catch(err => console.error("Auth error:", err));

    // 💬 Ask AI
    async function askAI() {
      const q = document.getElementById("q").value;
      if (!q) return;
      document.getElementById("q").value = "";

      const chat = document.getElementById("chat");
      chat.innerHTML += `<div class="msg user">You: ${q}</div>`;
      
      // Gemini API Call
      try {
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ role: "user", parts: [{ text: q }]}]
            })
          }
        );

        const data = await res.json();
        console.log("Gemini response:", data);

        let answer = "⚠️ No response";
        if (data?.candidates?.length > 0) {
          answer = data.candidates[0].content.parts[0].text;
        }

        chat.innerHTML += `<div class="msg ai">AI: ${answer}</div>`;

        // Save to stats
        const qId = q.toLowerCase().replace(/[^a-z0-9]/g, "_");
        const ref = db.collection("stats").doc(qId);
        await db.runTransaction(async (tx) => {
          const doc = await tx.get(ref);
          if (!doc.exists) {
            tx.set(ref, { question: q, count: 1 });
          } else {
            tx.update(ref, { count: (doc.data().count || 0) + 1 });
          }
        });

      } catch (err) {
        console.error("Gemini error:", err);
        chat.innerHTML += `<div class="msg ai">❌ Error: ${err.message}</div>`;
      }
    }

    // 🔔 Listen Notifications
    db.collection("notifications").orderBy("time", "desc").onSnapshot(snap => {
      const list = document.getElementById("notifList");
      list.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += `<li>${d.title || "Notice"}: ${d.message}</li>`;
      });
    });

    // 🛠 Maintenance
    db.collection("system").doc("maintenance").onSnapshot(doc => {
      const d = doc.data();
      document.getElementById("maintMsg").innerText = d?.active ? d.message : "No active maintenance";
    });

    // 📊 Stats
    db.collection("stats").orderBy("count", "desc").limit(5).onSnapshot(snap => {
      const list = document.getElementById("statsList");
      list.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += `<div>${d.question} → ${d.count}</div>`;
      });
    });
  </script>
</body>
</html>
